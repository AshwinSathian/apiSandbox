<div class="collections-sidebar flex h-full flex-col gap-4">
  <div class="flex items-center justify-between gap-3">
    <div>
      <p class="text-xs uppercase tracking-widest text-slate-400">
        Collections
      </p>
      <p class="text-base font-semibold text-white">Organize requests</p>
    </div>
    <div class="flex items-center gap-2">
      <button
        pButton
        icon="pi pi-bolt"
        size="small"
        text
        severity="secondary"
        (click)="openCommandPalette()"
        title="Command palette (⌘K)"
      ></button>
      <button
        pButton
        icon="pi pi-upload"
        size="small"
        text
        severity="secondary"
        (click)="fileInput.click()"
      ></button>
      <button
        pButton
        icon="pi pi-plus"
        size="small"
        severity="secondary"
        (click)="handleCreateCollection()"
      ></button>
    </div>
  </div>
  <input
    #fileInput
    type="file"
    accept="application/json"
    class="hidden"
    (change)="handleImportFile($event)"
  />

  @if (loading()) {
  <p-skeleton width="100%" height="200px"></p-skeleton>
  } @else if (!nodes().length) {
  <div class="rounded-lg border border-dashed border-slate-700 p-4 text-sm text-slate-400">
    No collections yet. Create one to start grouping your requests.
  </div>
  } @else {
  <p-tree
    [value]="nodes()"
    selectionMode="single"
    [draggableNodes]="true"
    [droppableNodes]="true"
    (onNodeSelect)="handleNodeSelect($event.node)"
    (onNodeDragEnd)="handleNodeSelect($event.node)"
    (onNodeDrop)="handleDrop($event)"
    (onNodeContextMenuSelect)="handleNodeSelect($event.node)"
    [contextMenu]="contextMenu"
  >
    <ng-template let-node pTemplate="default">
      <div class="flex w-full items-center gap-2">
        @if (editingKey() === node.key) {
        <input
          pInputText
          class="w-full bg-transparent text-sm"
          [(ngModel)]="editingValue"
          (keydown.enter)="commitRename(node)"
          (keydown.escape)="cancelEdit()"
          (blur)="commitRename(node)"
          autofocus
        />
        } @else {
        <span class="text-sm text-white">{{ node.label }}</span>
        }
      </div>
    </ng-template>
  </p-tree>
  }

  <p-contextMenu #contextMenu [model]="contextItems()"></p-contextMenu>
</div>

<p-dialog
  header="Import Collection"
  [(visible)]="importDialogVisible"
  [modal]="true"
  [style]="{ width: '420px' }"
  (onHide)="closeImportDialog()"
>
  @if (importErrors.length) {
  <div class="space-y-2 text-sm text-red-300">
    <p class="font-semibold">Unable to import file "{{ importFileName }}":</p>
    <ul class="list-disc pl-5">
      @for (error of importErrors; track error.path + error.message) {
      <li>{{ error.path }} — {{ error.message }}</li>
      }
    </ul>
  </div>
  } @else if (importAnalysis?.payload) {
  <div class="space-y-3 text-sm text-slate-300">
    <div>
      <p class="text-xs uppercase tracking-widest text-slate-500">Collection</p>
      <p class="text-lg font-semibold text-white">
        {{ importAnalysis.payload.collection.name }}
      </p>
      <p class="text-xs text-slate-400">
        {{ importAnalysis.summary?.folders || 0 }} folders ·
        {{ importAnalysis.summary?.requests || 0 }} requests
      </p>
    </div>
    <label
      class="flex items-center justify-between rounded-lg border border-slate-800/70 bg-slate-900/40 px-3 py-2 text-sm text-slate-200 cursor-pointer"
    >
      <div>
        <p class="text-xs uppercase tracking-widest text-slate-500">Duplicate as new</p>
        <p class="text-[11px] text-slate-400">
          Keeps the original intact and remaps every ID.
        </p>
      </div>
      <p-checkbox
        binary="true"
        [(ngModel)]="importDuplicateAsNew"
        [ngModelOptions]="{ standalone: true }"
        (ngModelChange)="toggleDuplicateImport($event)"
      ></p-checkbox>
    </label>
    @if (importAnalysis.plan?.length) {
    <div class="max-h-64 space-y-2 overflow-y-auto rounded-lg border border-slate-800/60 p-3">
      @for (entry of importAnalysis.plan; track entry.id) {
      <div class="flex items-center justify-between rounded-md bg-slate-900/60 px-3 py-2 text-xs text-slate-200">
        <div>
          <p class="font-semibold capitalize">{{ entry.type }} · {{ entry.name }}</p>
          <p class="text-[11px] text-slate-400">
            {{ entry.action === 'create' ? 'create new' : 'overwrite existing' }}
          </p>
        </div>
        <span
          class="rounded-full px-2 py-1 text-[10px] uppercase"
          [ngClass]="{
            'bg-emerald-600/20 text-emerald-200 border border-emerald-500/40': entry.action === 'create',
            'bg-amber-600/20 text-amber-200 border border-amber-500/40': entry.action === 'overwrite'
          }"
        >
          {{ entry.action }}
        </span>
      </div>
      }
    </div>
    }
  </div>
  } @else {
  <p class="text-sm text-slate-300">
    Select a valid collection export file to proceed.
  </p>
  }
  <ng-template pTemplate="footer">
    <div class="flex justify-end gap-2">
      <button pButton label="Cancel" severity="secondary" (click)="closeImportDialog()"></button>
      <button
        pButton
        label="Import"
        [disabled]="!importAnalysis?.payload || importErrors.length > 0"
        (click)="confirmImport()"
      ></button>
    </div>
  </ng-template>
</p-dialog>

<p-dialog
  [header]="creationTitle"
  [(visible)]="creationDialogVisible"
  [modal]="true"
  [style]="{ width: '420px' }"
  (onHide)="closeCreationDialog()"
>
  <div class="flex flex-col gap-3">
    <span class="text-xs uppercase tracking-widest text-slate-400">
      {{
        creationContext?.type === 'collection'
          ? 'Collection Name'
          : creationContext?.type === 'folder'
            ? 'Folder Name'
            : 'Request Name'
      }}
    </span>
    <input
      pInputText
      [(ngModel)]="creationModel.name"
      placeholder="Enter name"
      class="w-full"
    />
    @if (creationContext?.type === 'request') {
    <div class="flex flex-col gap-2">
      <span class="text-xs uppercase tracking-widest text-slate-400">
        Request Method
      </span>
      <p-select
        [options]="methodOptions"
        [(ngModel)]="creationModel.method"
        optionLabel="label"
        optionValue="value"
        class="w-full"
      ></p-select>
    </div>
    }
  </div>
  <ng-template pTemplate="footer">
    <div class="flex justify-end gap-2">
      <button
        pButton
        label="Cancel"
        severity="secondary"
        (click)="closeCreationDialog()"
      ></button>
      <button
        pButton
        label="Create"
        [disabled]="creationDisabled"
        (click)="submitCreation()"
      ></button>
    </div>
  </ng-template>
</p-dialog>

<p-dialog
  header="Command Palette"
  [(visible)]="commandPaletteVisible"
  [modal]="true"
  [style]="{ width: '420px' }"
  (onHide)="closeCommandPalette()"
>
  <div class="flex flex-col gap-3">
    <input
      pInputText
      placeholder="Type a command"
      class="w-full"
      [(ngModel)]="commandPaletteQuery"
      [ngModelOptions]="{ standalone: true }"
      (keydown.enter)="executeFirstPaletteAction()"
      autofocus
    />
    <div class="max-h-72 space-y-2 overflow-y-auto">
      @if (filteredPaletteActions.length) {
      @for (action of filteredPaletteActions; track action.id) {
      <button
        type="button"
        class="w-full rounded-lg border border-slate-800/70 bg-slate-900/30 px-3 py-2 text-left text-sm text-slate-200 hover:bg-slate-800/40"
        (click)="executePaletteAction(action)"
      >
        {{ action.label }}
      </button>
      }
      } @else {
      <div class="rounded-lg border border-dashed border-slate-700 px-3 py-4 text-center text-xs text-slate-500">
        No matching commands.
      </div>
      }
    </div>
  </div>
</p-dialog>

<p-confirmDialog></p-confirmDialog>
