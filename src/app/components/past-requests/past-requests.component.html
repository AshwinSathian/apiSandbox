<section
  class="h-full w-full"
  [ngClass]="{ 'border-none bg-transparent shadow-none': !displayHeader }"
>
  @if (displayHeader) {
  <ng-template pTemplate="header"> Request History </ng-template>
  }
  <div class="flex flex-col gap-1 w-full">
    @if (loading) {
    <div class="flex flex-col gap-1">
      @for (skeleton of skeletonPlaceholders; track skeleton) {
      <div class="rounded-lg border border-slate-800/60 bg-slate-900/50">
        <p-skeleton
          height="1.1rem"
          width="60%"
          borderRadius="0.75rem"
        ></p-skeleton>
        <div class="mt-2 flex gap-2">
          <p-skeleton
            height="0.9rem"
            width="5rem"
            borderRadius="9999px"
          ></p-skeleton>
          <p-skeleton
            height="0.9rem"
            width="4rem"
            borderRadius="9999px"
          ></p-skeleton>
          <p-skeleton
            height="0.9rem"
            width="7rem"
            borderRadius="9999px"
          ></p-skeleton>
        </div>
      </div>
      }
    </div>
    } @else if (!pastRequests.length) {
    <div
      class="text-center text-sm text-slate-400 uppercase tracking-wide w-full p-2"
    >
      No requests recorded yet. Run a request to see it listed here.
    </div>
    } @else { @for (request of pastRequests; track trackById($index, request)) {
    <div
      class="overflow-hidden rounded-lg bg-slate-900/60 transition hover:bg-slate-900/75"
    >
      <div class="hidden md:flex items-center gap-1">
        <span
          class="cursor-pointer truncate font-mono text-sm text-slate-300"
          [ngClass]="{
            'text-blue-400': request.method === 'GET',
            'text-emerald-400': request.method === 'POST',
            'text-amber-400': request.method === 'PUT',
            'text-red-400': request.method === 'DELETE',
            'text-purple-400': request.method === 'PATCH',
            'text-sky-400': request.method === 'OPTIONS',
            'text-slate-400': request.method === 'HEAD'
          }"
          (click)="load(request)"
          (mouseenter)="detailsPopover.show($event)"
          (mouseleave)="detailsPopover.hide()"
        >
          {{ request.url }}
        </span>
        <button
          pButton
          type="button"
          text
          severity="danger"
          class="uppercase"
          pTooltip="Delete request"
          tooltipPosition="top"
          (click)="confirmDelete(request, $event)"
        >
          <span class="material-icons text-base">delete</span>
        </button>

        <p-confirmpopup #cp>
          <ng-template #headless let-message>
            <div class="rounded p-4 text-sm">
              <span class="tracking-wide text-slate-300">
                {{ message.message }}
              </span>
              <div class="flex items-center gap-2 mt-4">
                <p-button
                  (onClick)="cp.onAccept()"
                  label="Delete"
                  severity="danger"
                  size="small"
                  text
                />
                <p-button
                  (onClick)="cp.onReject()"
                  label="Cancel"
                  text
                  size="small"
                  severity="secondary"
                  class="uppercase"
                />
              </div>
            </div>
          </ng-template>
        </p-confirmpopup>

        <p-popover
          #detailsPopover
          appendTo="body"
          [dismissable]="true"
          [styleClass]="'hidden md:block'"
        >
          <ng-container
            [ngTemplateOutlet]="requestDetails"
            [ngTemplateOutletContext]="{ request: request }"
          ></ng-container>
        </p-popover>
      </div>

      <div class="border-t border-slate-800/60 md:hidden my-2">
        <p-accordion>
          <p-accordion-panel [value]="request.id ?? $index">
            <p-accordion-header>
              <span
                class="text-xs font-semibold text-slate-300 truncate line-clamp-1"
                [ngClass]="{
                  'text-blue-400': request.method === 'GET',
                  'text-emerald-400': request.method === 'POST',
                  'text-amber-400': request.method === 'PUT',
                  'text-red-400': request.method === 'DELETE',
                  'text-purple-400': request.method === 'PATCH',
                  'text-sky-400': request.method === 'OPTIONS',
                  'text-slate-400': request.method === 'HEAD'
                }"
              >
                {{ request.url }}
              </span>
            </p-accordion-header>
            <p-accordion-content>
              <ng-container
                [ngTemplateOutlet]="requestDetails"
                [ngTemplateOutletContext]="{ request: request }"
              ></ng-container>
            </p-accordion-content>
          </p-accordion-panel>
        </p-accordion>
      </div>
    </div>
    } }
  </div>
</section>

<ng-template #requestDetails let-request="request">
  <div class="space-y-2 text-xs text-slate-100 min-w-fit">
    <div class="flex flex-col items-start">
      <span
        class="font-semibold font-mono text-sm text-slate-300 uppercase tracking-wider"
        [ngClass]="{
          'text-blue-400': request.method === 'GET',
          'text-emerald-400': request.method === 'POST',
          'text-amber-400': request.method === 'PUT',
          'text-red-400': request.method === 'DELETE',
          'text-purple-400': request.method === 'PATCH',
          'text-sky-400': request.method === 'OPTIONS',
          'text-slate-400': request.method === 'HEAD'
        }"
      >
        {{ request.method }}
      </span>
    </div>

    <div class="flex flex-wrap items-center justify-start">
      @if (request.status !== undefined) {
      <div class="flex items-center gap-1 p-2">
        <span class="material-symbols-outlined text-base text-sky-300">
          check_circle
        </span>
        <span>{{ request.status }}</span>
      </div>
      } @if (request.durationMs !== undefined) {
      <div class="flex items-center gap-1 p-2">
        <span class="material-symbols-outlined text-base text-emerald-400">
          schedule
        </span>
        <span>{{ request.durationMs }} ms</span>
      </div>
      }
      <div class="flex items-center gap-1 p-2">
        <span class="material-symbols-outlined text-base text-amber-300">
          calendar_month
        </span>
        <span>{{ request.createdAt | date : "short" }}</span>
      </div>
    </div>

    <div class="flex items-center justify-start gap-2 md:hidden">
      <button
        pButton
        type="button"
        text
        label="Load"
        severity="secondary"
        class="uppercase"
        size="small"
        (click)="load(request)"
      ></button>
      <button
        pButton
        type="button"
        text
        label="Delete"
        severity="danger"
        class="uppercase"
        size="small"
        (click)="confirmDelete(request, $event)"
      ></button>
    </div>
  </div>
</ng-template>
